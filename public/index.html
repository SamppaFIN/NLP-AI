<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TerapiaAI - Consciousness-Aware Therapy Assistant</title>
  
  <!-- Aurora UI Library -->
  <link rel="stylesheet" href="aurora-ui-library.css">
  <script src="aurora-ui-library.js"></script>
  
  <style>
    /* Import Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap');
    
    /* Custom therapy-specific styles */
    .therapy-container {
      min-height: 100vh;
      background: linear-gradient(135deg, 
        #0f172a 0%, 
        #1e293b 25%, 
        #334155 50%, 
        #475569 75%, 
        #64748b 100%);
      position: relative;
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    .therapy-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(147, 197, 253, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(96, 165, 250, 0.05) 0%, transparent 50%);
      z-index: -1;
      animation: cosmicFlow 20s ease-in-out infinite;
    }
    
    @keyframes cosmicFlow {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-20px, -20px) rotate(1deg); }
    }
    
    .session-flow {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--aurora-space-lg);
      padding: var(--aurora-space-xl);
    }
    
    .therapy-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
      animation: gentlePulse 3s ease-in-out infinite;
    }
    
    .therapy-avatar-inline {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--aurora-space-lg) auto;
      box-shadow: 0 6px 24px rgba(59, 130, 246, 0.3);
      animation: gentlePulse 3s ease-in-out infinite;
    }
    
    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Magnetic Cards */
    .magnetic-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--aurora-radius-lg);
      padding: var(--aurora-space-lg);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .magnetic-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(30, 64, 175, 0.2) 0%, 
        rgba(59, 130, 246, 0.2) 25%,
        rgba(96, 165, 250, 0.2) 50%, 
        rgba(147, 197, 253, 0.2) 75%,
        rgba(191, 219, 254, 0.2) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
    }
    
    .magnetic-card:hover::before {
      opacity: 1;
    }
    
    .magnetic-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.4);
    }
    
    .magnetic-card:active {
      transform: translateY(-2px) scale(1.01);
    }
    
    /* Enhanced Magnetic Buttons */
    .magnetic-btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      background: transparent;
      width: 100%;
      height: 100%;
      padding: 0;
    }
    
    .magnetic-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }
    
    .magnetic-btn:hover::before {
      opacity: 1;
    }
    
    .magnetic-btn:hover {
      transform: scale(1.05);
    }
    
    .magnetic-btn:active {
      transform: scale(0.98);
    }
    
    .btn-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--aurora-space-sm);
      padding: var(--aurora-space-md);
      position: relative;
      z-index: 2;
    }
    
    .btn-icon {
      font-size: 1.5rem;
      transition: transform 0.3s ease;
    }
    
    .btn-text {
      font-size: 0.9rem;
      font-weight: 500;
      color: inherit;
    }
    
    .magnetic-btn:hover .btn-icon {
      transform: scale(1.2) rotate(5deg);
    }
    
    /* Card Content */
    .card-content {
      position: relative;
      z-index: 2;
    }
    
    .card-label {
      display: block;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: var(--aurora-space-sm);
      font-weight: 500;
    }
    
    /* Magnetic Select */
    .magnetic-select {
      background: rgba(0, 0, 0, 0.3);
      color: #ffffff;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: var(--aurora-radius-md);
      padding: var(--aurora-space-sm) var(--aurora-space-md);
      width: 100%;
      transition: all 0.3s ease;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .magnetic-select:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.7);
    }
    
    .magnetic-select:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.5);
      border-color: #ffffff;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    }
    
    .magnetic-select option {
      background: #1a1a2e;
      color: #ffffff;
      padding: 8px;
    }
    
    /* Magnetic Textarea */
    .magnetic-textarea {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--aurora-radius-md);
      padding: var(--aurora-space-md);
      width: 100%;
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    .magnetic-textarea:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .magnetic-textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--aurora-primary);
      box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.3);
    }
    
    .magnetic-textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* Action Buttons Layout */
    .action-buttons {
      display: flex;
      gap: var(--aurora-space-md);
      justify-content: center;
      margin-top: var(--aurora-space-lg);
      flex-wrap: wrap;
    }
    
    .action-card {
      min-width: 120px;
      flex: 1;
      max-width: 150px;
    }
    
    /* Summary Card */
    .summary-card {
      max-width: 800px;
      margin: var(--aurora-space-lg) auto;
    }
    
    .summary-content {
      text-align: left;
      white-space: pre-wrap;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .question-card {
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    
    .question-text {
      font-family: 'Poppins', sans-serif;
      font-size: 1.6rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: var(--aurora-space-lg);
      line-height: 1.7;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #ffffff, #f0f8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .progress-indicator {
      display: flex;
      justify-content: center;
      gap: var(--aurora-space-sm);
      margin-bottom: var(--aurora-space-lg);
    }
    
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .progress-dot.active {
      background: var(--aurora-secondary);
      box-shadow: 0 0 20px var(--aurora-secondary);
    }
    
    .progress-dot.completed {
      background: var(--aurora-primary);
    }
    
    .input-section {
      max-width: 600px;
      width: 100%;
    }
    
    .conversation-log {
      max-width: 800px;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--aurora-radius-md);
      padding: var(--aurora-space-md);
      margin-top: var(--aurora-space-lg);
    }
    
    .message {
      margin-bottom: var(--aurora-space-md);
      padding: var(--aurora-space-md);
      border-radius: var(--aurora-radius-md);
    }
    
    .message.user {
      background: rgba(74, 158, 255, 0.2);
      margin-left: 20%;
    }
    
    .message.assistant {
      background: rgba(0, 255, 136, 0.2);
      margin-right: 20%;
    }
    
    .session-controls {
      display: flex;
      gap: var(--aurora-space-md);
      justify-content: center;
      margin-top: var(--aurora-space-lg);
    }
    
    .hidden {
      display: none !important;
    }
    
    .summary-screen {
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .summary-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: var(--aurora-radius-lg);
      padding: var(--aurora-space-xl);
      margin: var(--aurora-space-lg) 0;
      text-align: left;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    
    @media (max-width: 768px) {
      .session-flow {
        padding: var(--aurora-space-md);
      }
      
      .question-text {
        font-size: 1.25rem;
      }
      
      .therapy-avatar {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="therapy-container">
    <!-- Main Session Screen -->
    <div id="sessionScreen" class="session-flow">
      <!-- Header -->
      <div class="therapy-avatar" id="therapyAvatar">
        <svg width="120" height="120" viewBox="0 0 120 120" id="therapistSvg">
          <!-- Face -->
          <circle cx="60" cy="45" r="22" fill="#fde68a" stroke="#f59e0b" stroke-width="2"/>
          <!-- Body -->
          <rect x="30" y="67" width="60" height="35" rx="17" fill="#60a5fa" stroke="#3b82f6" stroke-width="2"/>
          <!-- Eyes -->
          <circle id="leftEye" cx="52" cy="42" r="3" fill="#111827"/>
          <circle id="rightEye" cx="68" cy="42" r="3" fill="#111827"/>
          <!-- Mouth -->
          <circle id="mouth" cx="60" cy="52" r="3" fill="#111827"/>
          <!-- Eyebrows -->
          <path id="leftEyebrow" d="M47 35 Q52 33 57 35" stroke="#111827" stroke-width="2" fill="none"/>
          <path id="rightEyebrow" d="M63 35 Q68 33 73 35" stroke="#111827" stroke-width="2" fill="none"/>
        </svg>
      </div>
      
      <h1 style="color: var(--aurora-white); text-align: center; margin-bottom: var(--aurora-space-lg);">
        TerapiaAI
      </h1>
      
      <p style="color: rgba(255, 255, 255, 0.8); text-align: center; max-width: 500px;">
        Tervetuloa henkilökohtaiseen terapiakeskusteluun. Tietosi pysyvät tällä laitteella.
      </p>
      
      <!-- NLP Info Button -->
      <div style="text-align: center; margin-bottom: var(--aurora-space-lg);">
        <div class="aurora-card magnetic-card" style="display: inline-block; margin-right: 10px;">
          <button id="nlpInfoBtn" class="aurora-btn aurora-btn-ghost magnetic-btn" style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
            ℹ️ Mikä on NLP ja miten tietojani käsitellään?
          </button>
        </div>
        <div class="aurora-card magnetic-card" style="display: inline-block;">
          <button id="voiceTestBtn" class="aurora-btn aurora-btn-ghost magnetic-btn" style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
            🎤 Testaa ääni
          </button>
        </div>
      </div>
      
      <!-- Session Controls -->
      <div class="session-controls">
        <div class="aurora-card magnetic-card" id="startSessionCard">
          <button id="startSessionBtn" class="aurora-btn aurora-btn-cosmic magnetic-btn">
            <div class="btn-content">
              <div class="btn-icon">🚀</div>
              <div class="btn-text">Aloita Uusi Sessio</div>
            </div>
          </button>
        </div>
      </div>
      
      <!-- Voice Controls -->
      <div id="voiceControls" class="session-controls hidden">
        <div class="aurora-card magnetic-card" id="personaCard">
          <div class="card-content">
            <label class="card-label">AI Persona</label>
            <select id="personaSelect" class="aurora-select magnetic-select">
              <option value="carl_rogers">Carl Rogers - Henkilökeskeinen</option>
              <option value="freud">Freud - Psykoanalyytikko</option>
              <option value="jung">Jung - Analyyttinen</option>
              <option value="cbt">CBT - Kognitiivinen</option>
              <option value="gestalt">Gestalt - Kokemuksellinen</option>
              <option value="existential">Eksistentiaalinen</option>
              <option value="virginia_satir">Virginia Satir - Perheterapeutti</option>
              <option value="marsha_linehan">Marsha Linehan - DBT-terapeutti</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Question Card -->
      <div id="questionCard" class="aurora-card magnetic-card question-card hidden">
        <div class="card-content">
          <!-- Therapist Avatar in Question Card -->
          <div class="therapy-avatar-inline" id="therapyAvatarInline">
            <svg width="80" height="80" viewBox="0 0 120 120" id="therapistSvgInline">
              <!-- Face -->
              <circle cx="60" cy="45" r="22" fill="#fde68a" stroke="#f59e0b" stroke-width="2"/>
              <!-- Body -->
              <rect x="30" y="67" width="60" height="35" rx="17" fill="#60a5fa" stroke="#3b82f6" stroke-width="2"/>
              <!-- Eyes -->
              <circle id="leftEyeInline" cx="52" cy="42" r="3" fill="#111827"/>
              <circle id="rightEyeInline" cx="68" cy="42" r="3" fill="#111827"/>
              <!-- Mouth -->
              <circle id="mouthInline" cx="60" cy="52" r="3" fill="#111827"/>
              <!-- Eyebrows -->
              <path id="leftEyebrowInline" d="M47 35 Q52 33 57 35" stroke="#111827" stroke-width="2" fill="none"/>
              <path id="rightEyebrowInline" d="M63 35 Q68 33 73 35" stroke="#111827" stroke-width="2" fill="none"/>
            </svg>
          </div>
          
          <div class="progress-indicator" id="progressIndicator">
            <!-- Progress dots will be generated here -->
          </div>
          
          <div class="question-text" id="questionText">
            Valmistaudutaan ensimmäiseen kysymykseen...
          </div>
          
          <div class="input-section">
            <div class="aurora-input-group magnetic-input">
              <textarea 
                id="userInput" 
                class="aurora-textarea magnetic-textarea" 
                placeholder="Jaa ajatuksiasi vapaasti..."
                rows="4"
              ></textarea>
            </div>
            
            <div class="action-buttons">
              <div class="aurora-card magnetic-card action-card">
                <button id="sendBtn" class="aurora-btn aurora-btn-primary magnetic-btn">
                  <div class="btn-content">
                    <div class="btn-icon">💬</div>
                    <div class="btn-text">Lähetä Vastaus</div>
                  </div>
                </button>
              </div>
              
              <div class="aurora-card magnetic-card action-card">
                <button id="micBtn" class="aurora-btn aurora-btn-accent magnetic-btn">
                  <div class="btn-content">
                    <div class="btn-icon">🎤</div>
                    <div class="btn-text">Puhu</div>
                  </div>
                </button>
              </div>
              
              <div class="aurora-card magnetic-card action-card">
                <button id="skipBtn" class="aurora-btn aurora-btn-secondary magnetic-btn">
                  <div class="btn-content">
                    <div class="btn-icon">⏭️</div>
                    <div class="btn-text">Ohita</div>
                  </div>
                </button>
              </div>
              
              <div class="aurora-card magnetic-card action-card hidden">
                <button id="nextBtn" class="aurora-btn aurora-btn-success magnetic-btn">
                  <div class="btn-content">
                    <div class="btn-icon">➡️</div>
                    <div class="btn-text">Seuraava</div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Conversation Log -->
      <div id="conversationLog" class="conversation-log hidden">
        <h3 style="color: var(--aurora-white); margin-bottom: var(--aurora-space-md);">Keskustelu</h3>
        <div id="messagesContainer"></div>
      </div>
    </div>
    
    <!-- Summary Screen -->
    <div id="summaryScreen" class="session-flow hidden">
      <div class="summary-screen">
        <div class="therapy-avatar">✨</div>
        
        <h1 style="color: var(--aurora-white);">Sessio Yhteenveto</h1>
        
        <div class="aurora-card magnetic-card summary-card">
          <div class="card-content">
            <div class="summary-content" id="summaryContent">
              Luodaan henkilökohtaista yhteenvetoa...
            </div>
          </div>
        </div>
        
        <div class="session-controls">
          <div class="aurora-card magnetic-card">
            <button id="downloadSummaryBtn" class="aurora-btn aurora-btn-primary magnetic-btn">
              <div class="btn-content">
                <div class="btn-icon">📥</div>
                <div class="btn-text">Lataa Yhteenveto</div>
              </div>
            </button>
          </div>
          
          <div class="aurora-card magnetic-card">
            <button id="newSessionBtn" class="aurora-btn aurora-btn-cosmic magnetic-btn">
              <div class="btn-content">
                <div class="btn-icon">🚀</div>
                <div class="btn-text">Uusi Sessio</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NLP Info Modal -->
  <div id="nlpInfoModal" class="aurora-modal">
    <div class="aurora-modal__backdrop"></div>
    <div class="aurora-modal__content aurora-modal__content--medium">
      <div class="aurora-modal__header">
        <h2 class="aurora-modal__title">Mikä on NLP ja tietojen käsittely</h2>
        <button class="aurora-modal__close" id="closeNlpModal">&times;</button>
      </div>
      <div class="aurora-modal__body">
        <h3>Mikä on NLP (Natural Language Processing)?</h3>
        <p>NLP on tekoälyn osa-alue, joka mahdollistaa tietokoneiden ymmärtää ja käsitellä ihmisten kieltä. TerapiaAI käyttää NLP:ää:</p>
        <ul>
          <li><strong>Ymmärtämään</strong> vastauksesi ja tunnistamaan tärkeimmät teemat</li>
          <li><strong>Generoimaan</strong> henkilökohtaisia terapeuttisia vastauksia</li>
          <li><strong>Analysoimaan</strong> keskustelun tunnelmaa ja kehitystä</li>
          <li><strong>Luomaan</strong> sessioiden yhteenvetoja</li>
        </ul>
        
        <h3>Miten tietojasi käsitellään?</h3>
        <p><strong>🔒 Tietoturvallisuus:</strong></p>
        <ul>
          <li>Kaikki keskustelut pysyvät <strong>tällä laitteella</strong></li>
          <li>Tietoja ei tallenneta ulkoisiin palvelimiin</li>
          <li>Keskustelut eivät jää pysyvästi tallennettuina</li>
          <li>API-kutsut tehdään salatusti HTTPS:n kautta</li>
        </ul>
        
        <p><strong>🤖 AI-käsittely:</strong></p>
        <ul>
          <li>Vastauksesi lähetetään OpenRouter-palvelun kautta AI-mallille</li>
          <li>AI generoi vastauksen perustuen valittuun terapiateoriaan</li>
          <li>Keskusteluhistoria käytetään kontekstin ymmärtämiseen</li>
          <li>Yhteenveto luodaan sessioiden lopuksi</li>
        </ul>
        
        <p><strong>📊 Anonymiteetti:</strong></p>
        <ul>
          <li>Henkilöllisyytesi ei tallenneta</li>
          <li>Keskustelut eivät linkity henkilökohtaisiin tietoihin</li>
          <li>Kaikki data on anonymisoitua</li>
        </ul>
        
        <p style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
          <strong>💡 Vinkki:</strong> TerapiaAI on apuväline, ei korvaa ammattimaista terapiaa. Jos tarvitset kriisitukea, ota yhteyttä ammattilaisiin.
        </p>
      </div>
    </div>
  </div>

  <script>
    // Initialize Aurora UI
    const aurora = new AuroraUILibrary({
      theme: 'cosmic',
      accessibility: true,
      mobile: true
    });

    // Global state
    let sessionId = null;
    let currentQuestion = 0;
    let totalQuestions = 10;
    let sessionStarted = false;
    let currentSummary = '';
    let micOn = true;
    let voiceOn = true;
    let recognition = null;
    let currentPersona = 'carl_rogers';
    
    // Voice and Speech Recognition
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('Speech recognition not supported');
        return null;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'fi-FI';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onstart = () => {
        micOn = true;
        elements.micBtn.querySelector('.btn-text').textContent = 'Puhu';
        elements.micBtn.classList.add('aurora-btn-accent');
        setTherapistExpression('listening');
      };
      
      recognition.onend = () => {
        micOn = false;
        elements.micBtn.querySelector('.btn-text').textContent = 'Puhu';
        elements.micBtn.classList.remove('aurora-btn-accent');
        setTherapistExpression('neutral');
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        elements.userInput.value = transcript;
        setTherapistExpression('thinking');
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        micOn = false;
        elements.micBtn.querySelector('.btn-text').textContent = 'Puhu';
        elements.micBtn.classList.remove('aurora-btn-accent');
      };
      
      return recognition;
    }
    
    // Therapist expressions
    function setTherapistExpression(emotion) {
      const leftEye = document.getElementById('leftEyeInline');
      const rightEye = document.getElementById('rightEyeInline');
      const mouth = document.getElementById('mouthInline');
      const leftEyebrow = document.getElementById('leftEyebrowInline');
      const rightEyebrow = document.getElementById('rightEyebrowInline');
      
      if (!leftEye || !rightEye || !mouth) return;
      
      switch(emotion) {
        case 'listening':
          leftEyebrow.setAttribute('d', 'M47 33 Q52 31 57 33');
          rightEyebrow.setAttribute('d', 'M63 33 Q68 31 73 33');
          mouth.setAttribute('r', '2');
          break;
        case 'thinking':
          leftEyebrow.setAttribute('d', 'M47 37 Q52 35 57 37');
          rightEyebrow.setAttribute('d', 'M63 37 Q68 35 73 37');
          mouth.setAttribute('r', '2');
          break;
        case 'empathetic':
          leftEyebrow.setAttribute('d', 'M47 33 Q52 32 57 33');
          rightEyebrow.setAttribute('d', 'M63 33 Q68 32 73 33');
          mouth.setAttribute('r', '4');
          break;
        case 'talking':
          leftEyebrow.setAttribute('d', 'M47 33 Q52 32 57 33');
          rightEyebrow.setAttribute('d', 'M63 33 Q68 32 73 33');
          mouth.setAttribute('r', '5');
          break;
        default: // neutral
          leftEyebrow.setAttribute('d', 'M47 35 Q52 33 57 35');
          rightEyebrow.setAttribute('d', 'M63 35 Q68 33 73 35');
          mouth.setAttribute('r', '3');
      }
    }
    
    // Voice configurations for each persona
    const voiceConfigs = {
      carl_rogers: {
        name: 'Carl Rogers',
        gender: 'male',
        rate: 0.8,
        pitch: 0.9,
        volume: 0.9,
        voiceIndex: 0,
        description: 'Warm, empathetic, person-centered'
      },
      freud: {
        name: 'Freud',
        gender: 'male',
        rate: 0.7,
        pitch: 0.85,
        volume: 0.8,
        voiceIndex: 1,
        description: 'Deep, analytical, psychoanalytic'
      },
      jung: {
        name: 'Jung',
        gender: 'male',
        rate: 0.75,
        pitch: 0.9,
        volume: 0.85,
        voiceIndex: 2,
        description: 'Wise, symbolic, analytical'
      },
      cbt: {
        name: 'CBT',
        gender: 'male',
        rate: 0.9,
        pitch: 1.0,
        volume: 0.9,
        voiceIndex: 3,
        description: 'Clear, practical, solution-focused'
      },
      gestalt: {
        name: 'Gestalt',
        gender: 'male',
        rate: 0.85,
        pitch: 0.95,
        volume: 0.88,
        voiceIndex: 4,
        description: 'Present-focused, experiential'
      },
      existential: {
        name: 'Existential',
        gender: 'male',
        rate: 0.7,
        pitch: 0.9,
        volume: 0.8,
        voiceIndex: 5,
        description: 'Philosophical, deep, meaningful'
      },
      virginia_satir: {
        name: 'Virginia Satir',
        gender: 'female',
        rate: 0.8,
        pitch: 1.1,
        volume: 0.9,
        voiceIndex: 6,
        description: 'Warm, family-focused, systemic'
      },
      marsha_linehan: {
        name: 'Marsha Linehan',
        gender: 'female',
        rate: 0.85,
        pitch: 1.15,
        volume: 0.88,
        voiceIndex: 7,
        description: 'Compassionate, dialectical, mindfulness-based'
      }
    };

    // Available voices
    let availableVoices = [];
    let currentVoiceIndex = 0;

    // Initialize voices
    function initVoices() {
      // Load voices when they become available
      if (speechSynthesis.getVoices().length > 0) {
        availableVoices = speechSynthesis.getVoices();
        console.log('🎤 Available voices:', availableVoices.length);
        console.log('🎤 Voices:', availableVoices.map(v => `${v.name} (${v.lang})`));
        logVoiceAssignments();
      } else {
        // Wait for voices to load
        speechSynthesis.addEventListener('voiceschanged', () => {
          availableVoices = speechSynthesis.getVoices();
          console.log('🎤 Available voices loaded:', availableVoices.length);
          console.log('🎤 Voices:', availableVoices.map(v => `${v.name} (${v.lang})`));
          logVoiceAssignments();
        });
      }
    }

    // Log voice assignments for each persona
    function logVoiceAssignments() {
      console.log('🎤 Voice assignments:');
      Object.keys(voiceConfigs).forEach(persona => {
        const voice = getVoiceForPersona(persona);
        const config = voiceConfigs[persona];
        if (voice) {
          console.log(`  ${config.name} (${config.gender}): ${voice.name} (${voice.lang}) - Rate: ${config.rate}, Pitch: ${config.pitch}`);
        } else {
          console.log(`  ${config.name} (${config.gender}): No voice available`);
        }
      });
    }

    // Test voice for current persona
    function testCurrentVoice() {
      if (availableVoices.length === 0) {
        showNotification('Äänet eivät ole vielä ladattu. Odota hetki.', 'warning');
        return;
      }
      
      const config = voiceConfigs[currentPersona];
      const voice = getVoiceForPersona(currentPersona);
      
      if (voice && config) {
        const testPhrase = `Hei, olen ${config.name}. Tämä on testi äänestäni.`;
        speakText(testPhrase);
        showNotification(`Testataan ${config.name} -äänen: ${voice.name}`, 'info');
      } else {
        showNotification('Ääntä ei löytynyt tälle personalle.', 'error');
      }
    }

    // Get voice for current persona
    function getVoiceForPersona(persona) {
      const config = voiceConfigs[persona];
      if (!config) return null;

      // Separate male and female voices
      const maleVoices = availableVoices.filter(voice => 
        voice.name.toLowerCase().includes('male') || 
        voice.name.toLowerCase().includes('david') ||
        voice.name.toLowerCase().includes('mark') ||
        voice.name.toLowerCase().includes('male') ||
        voice.name.toLowerCase().includes('man')
      );
      
      const femaleVoices = availableVoices.filter(voice => 
        voice.name.toLowerCase().includes('female') || 
        voice.name.toLowerCase().includes('heidi') ||
        voice.name.toLowerCase().includes('susan') ||
        voice.name.toLowerCase().includes('female') ||
        voice.name.toLowerCase().includes('woman')
      );

      let preferredVoice = null;

      if (config.gender === 'female' && femaleVoices.length > 0) {
        // Use female voice based on persona index
        const voiceIndex = config.voiceIndex % femaleVoices.length;
        preferredVoice = femaleVoices[voiceIndex];
      } else if (config.gender === 'male' && maleVoices.length > 0) {
        // Use male voice based on persona index
        const voiceIndex = config.voiceIndex % maleVoices.length;
        preferredVoice = maleVoices[voiceIndex];
      }

      // Fallback: try Finnish voices first, then English
      if (!preferredVoice) {
        preferredVoice = availableVoices.find(voice => voice.lang.startsWith('fi'));
        if (!preferredVoice) {
          preferredVoice = availableVoices.find(voice => voice.lang.startsWith('en'));
        }
        if (!preferredVoice && availableVoices.length > 0) {
          const voiceIndex = config.voiceIndex % availableVoices.length;
          preferredVoice = availableVoices[voiceIndex];
        }
      }

      return preferredVoice;
    }

    // Text-to-Speech with persona-specific voice
    function speakText(text) {
      if (!voiceOn) return;
      
      if (micOn && recognition) {
        recognition.stop();
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'fi-FI';
      
      // Get voice configuration for current persona
      const config = voiceConfigs[currentPersona];
      if (config) {
        utterance.rate = config.rate;
        utterance.pitch = config.pitch;
        utterance.volume = config.volume;
        
        // Set specific voice
        const voice = getVoiceForPersona(currentPersona);
        if (voice) {
          utterance.voice = voice;
          console.log(`🎤 Speaking as ${config.name} using voice: ${voice.name}`);
        }
      } else {
        // Default settings
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 0.9;
      }
      
      utterance.onstart = () => {
        setTherapistExpression('talking');
        console.log(`🎤 Started speaking as ${voiceConfigs[currentPersona]?.name || 'Default'}`);
      };
      
      utterance.onend = () => {
        setTherapistExpression('empathetic');
        console.log(`🎤 Finished speaking as ${voiceConfigs[currentPersona]?.name || 'Default'}`);
        if (micOn && recognition) {
          setTimeout(() => recognition.start(), 500);
        }
      };
      
      utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event.error);
        setTherapistExpression('neutral');
      };
      
      speechSynthesis.speak(utterance);
    }
    
    // Questions in Finnish - Original Kalle Kotipsykiatri style
    const questions = [
      'Miten voitte tänään?',
      'Mikä on tärkeintä elämässänne juuri nyt?',
      'Miltä tuntuu kun ajattelette tulevaisuutta?',
      'Mitä haluaisitte muuttaa elämässänne?',
      'Mistä saatte iloa ja energiaa?',
      'Mikä on vaikeinta teille tällä hetkellä?',
      'Miten koette itsenne?',
      'Mitä unelmoitte tekisitte jos voisitte?',
      'Mistä olette kiitollisia?',
      'Minkälaista tukea tarvitsette?'
    ];

    // Persona system prompts - Based on real therapy approaches
    const personaPrompts = {
      carl_rogers: 'Olet Carl Rogers -henkilökeskeinen terapeutti. Käytä aktiivista kuuntelua, peilaile tunteita ja anna ehdottoman positiivista katsetta. Anna lyhyt, ymmärtävä vastaus (1-2 lausetta).',
      freud: 'Olet Freud-tyylinen psykoanalyytikko. Tutki alitajuntaisia motiiveja ja lapsuuden kokemuksia. Anna syvällinen, analyyttinen vastaus (1-2 lausetta).',
      jung: 'Olet Jung-tyylinen analyyttinen terapeutti. Tutki arkkityyppejä, unia ja henkilökohtaista kehitystä. Anna viisas, symbolinen vastaus (1-2 lausetta).',
      cbt: 'Olet CBT-kognitiivinen terapeutti. Tutki ajatusmalleja ja käyttäytymisympyrää. Anna käytännöllinen, ratkaisukeskeinen vastaus (1-2 lausetta).',
      gestalt: 'Olet Gestalt-kokemuksellinen terapeutti. Keskity nykyhetkeen ja kehon tuntemuksiin. Anna elävä, kokemuksellinen vastaus (1-2 lausetta).',
      existential: 'Olet eksistentiaalinen terapeutti. Tutki elämän merkitystä, vapautta ja vastuuta. Anna syvällinen, filosofinen vastaus (1-2 lausetta).',
      virginia_satir: 'Olet Virginia Satir -perheterapeutti. Keskity perhesuhteisiin, kommunikaatioon ja perheen voimaan. Anna lämmittävä, perhekeskeinen vastaus (1-2 lausetta).',
      marsha_linehan: 'Olet Marsha Linehan -DBT-terapeutti. Käytä dialektista käyttäytymisterapiaa, mindfulnessia ja emotionaalista säätelyä. Anna myötätuntoinen, tasapainottava vastaus (1-2 lausetta).'
    };

    // DOM elements
    const elements = {
      sessionScreen: document.getElementById('sessionScreen'),
      summaryScreen: document.getElementById('summaryScreen'),
      startSessionBtn: document.getElementById('startSessionBtn'),
      startSessionCard: document.getElementById('startSessionCard'),
      voiceControls: document.getElementById('voiceControls'),
      micBtn: document.getElementById('micBtn'),
      personaSelect: document.getElementById('personaSelect'),
      personaCard: document.getElementById('personaCard'),
      questionCard: document.getElementById('questionCard'),
      questionText: document.getElementById('questionText'),
      progressIndicator: document.getElementById('progressIndicator'),
      userInput: document.getElementById('userInput'),
      sendBtn: document.getElementById('sendBtn'),
      skipBtn: document.getElementById('skipBtn'),
      nextBtn: document.getElementById('nextBtn'),
      conversationLog: document.getElementById('conversationLog'),
      messagesContainer: document.getElementById('messagesContainer'),
      therapyAvatar: document.getElementById('therapyAvatar'),
      summaryContent: document.getElementById('summaryContent'),
      downloadSummaryBtn: document.getElementById('downloadSummaryBtn'),
      newSessionBtn: document.getElementById('newSessionBtn'),
      nlpInfoBtn: document.getElementById('nlpInfoBtn'),
      nlpInfoModal: document.getElementById('nlpInfoModal'),
      closeNlpModal: document.getElementById('closeNlpModal'),
      voiceTestBtn: document.getElementById('voiceTestBtn')
    };

    // Initialize progress indicator
    function initProgressIndicator() {
      elements.progressIndicator.innerHTML = '';
      for (let i = 0; i < totalQuestions; i++) {
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        if (i < currentQuestion) dot.classList.add('completed');
        else if (i === currentQuestion) dot.classList.add('active');
        elements.progressIndicator.appendChild(dot);
      }
    }

    // Update progress
    function updateProgress() {
      const dots = elements.progressIndicator.querySelectorAll('.progress-dot');
      dots.forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index < currentQuestion) dot.classList.add('completed');
        else if (index === currentQuestion) dot.classList.add('active');
      });
    }

    // Show question
    function showQuestion() {
      if (currentQuestion < totalQuestions) {
        elements.questionText.textContent = questions[currentQuestion];
        elements.userInput.value = '';
        updateProgress();
        
        // Therapist reads the question aloud
        speakText(questions[currentQuestion]);
        
        // Focus input after question is spoken
        setTimeout(() => {
          elements.userInput.focus();
          // Start mic listening after question is spoken
          if (micOn && recognition) {
            recognition.start();
          }
        }, 2000); // Wait 2 seconds for question to be spoken
      }
    }

    // Add message to conversation
    function addMessage(content, role) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      messageDiv.textContent = content;
      elements.messagesContainer.appendChild(messageDiv);
      elements.conversationLog.scrollTop = elements.conversationLog.scrollHeight;
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Create simple notification without Aurora toast
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--aurora-secondary)' : type === 'error' ? 'var(--aurora-accent)' : 'var(--aurora-primary)'};
        color: white;
        padding: 12px 16px;
        border-radius: var(--aurora-radius-md);
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Start new session
    async function startSession() {
      try {
        // Create session
        const response = await fetch('/api/session', { method: 'POST' });
        const data = await response.json();
        sessionId = data.id;
        
        // Start session
        await fetch(`/api/session/${sessionId}/start`, { method: 'POST' });
        
        sessionStarted = true;
        currentQuestion = 0;
        
        // Update UI
        elements.startSessionCard.classList.add('hidden');
        elements.voiceControls.classList.remove('hidden');
        elements.questionCard.classList.remove('hidden');
        elements.conversationLog.classList.remove('hidden');
        
        // Initialize speech recognition
        initSpeechRecognition();
        
        initProgressIndicator();
        showQuestion();
        
        showNotification('Sessio aloitettu! Voitte aloittaa vastaamalla kysymykseen.', 'success');
        
      } catch (error) {
        console.error('Error starting session:', error);
        showNotification('Virhe session aloittamisessa. Yritä uudelleen.', 'error');
      }
    }

    // Send message
    async function sendMessage() {
      const content = elements.userInput.value.trim();
      if (!content) return;
      
      try {
        // Add user message to conversation
        addMessage(content, 'user');
        
        // Get AI response with current persona
        const messages = [
          { 
            role: 'system', 
            content: personaPrompts[currentPersona]
          },
          { 
            role: 'user', 
            content: `Kysymys: ${questions[currentQuestion]}\n\nKäyttäjän vastaus: ${content}` 
          }
        ];
        
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, task: 'therapy_response', sessionId })
        });
        
        const data = await response.json();
        
        if (data.content) {
          addMessage(data.content, 'assistant');
          
          // Speak the response
          speakText(data.content);
          
          currentQuestion++;
          
          if (currentQuestion >= totalQuestions) {
            // Session complete - generate summary
            await generateSummary();
          } else {
            // Automatically progress to next question
            setTimeout(() => {
              showQuestion();
            }, 1500); // Wait 1.5 seconds before next question
          }
        }
        
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Virhe viestin lähettämisessä. Yritä uudelleen.', 'error');
      }
    }

    // Skip question
    function skipQuestion() {
      addMessage('Kysymys ohitettu.', 'user');
      currentQuestion++;
      
      if (currentQuestion >= totalQuestions) {
        generateSummary();
      } else {
        // Automatically progress to next question
        setTimeout(() => {
          showQuestion();
        }, 1000); // Wait 1 second before next question
      }
    }

    // Next question
    function nextQuestion() {
      elements.sendBtn.classList.remove('hidden');
      elements.skipBtn.classList.remove('hidden');
      elements.nextBtn.classList.add('hidden');
      elements.userInput.disabled = false;
      elements.userInput.focus();
      showQuestion();
    }

    // Generate summary
    async function generateSummary() {
      try {
        elements.summaryContent.textContent = 'Luodaan henkilökohtaista yhteenvetoa...';
        
        const response = await fetch('/api/summary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        
        const data = await response.json();
        
        if (data.summary) {
          currentSummary = data.summary;
          elements.summaryContent.textContent = data.summary;
          
          // Show summary screen
          elements.sessionScreen.classList.add('hidden');
          elements.summaryScreen.classList.remove('hidden');
          
          showNotification('Sessio valmis! Yhteenveto on luotu.', 'success');
        }
        
      } catch (error) {
        console.error('Error generating summary:', error);
        showNotification('Virhe yhteenvedon luomisessa.', 'error');
      }
    }

    // Download summary
    function downloadSummary() {
      const blob = new Blob([currentSummary], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `terapia-sessio-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // End session
    async function endSession() {
      if (sessionId) {
        await fetch(`/api/session/${sessionId}/end`, { method: 'POST' });
      }
      
      // Stop speech recognition and synthesis
      if (recognition) recognition.stop();
      speechSynthesis.cancel();
      
      // Reset UI
      sessionStarted = false;
      sessionId = null;
      currentQuestion = 0;
      micOn = false;
      
      elements.startSessionCard.classList.remove('hidden');
      elements.voiceControls.classList.add('hidden');
      elements.questionCard.classList.add('hidden');
      elements.conversationLog.classList.add('hidden');
      elements.summaryScreen.classList.add('hidden');
      
      elements.messagesContainer.innerHTML = '';
      elements.micBtn.querySelector('.btn-text').textContent = 'Puhu';
      elements.micBtn.classList.add('aurora-btn-accent');
      
      setTherapistExpression('neutral');
      
      showNotification('Sessio päättynyt.', 'info');
    }

    // Modal functions
    function openNlpModal() {
      elements.nlpInfoModal.classList.add('aurora-modal--open');
    }
    
    function closeNlpModal() {
      elements.nlpInfoModal.classList.remove('aurora-modal--open');
    }

    // Event listeners
    elements.startSessionBtn.addEventListener('click', startSession);
    elements.sendBtn.addEventListener('click', sendMessage);
    elements.skipBtn.addEventListener('click', skipQuestion);
    elements.nextBtn.addEventListener('click', nextQuestion);
    elements.downloadSummaryBtn.addEventListener('click', downloadSummary);
    elements.newSessionBtn.addEventListener('click', () => {
      elements.summaryScreen.classList.add('hidden');
      elements.sessionScreen.classList.remove('hidden');
      startSession();
    });
    
    // NLP Info Modal
    elements.nlpInfoBtn.addEventListener('click', openNlpModal);
    elements.closeNlpModal.addEventListener('click', closeNlpModal);
    elements.nlpInfoModal.addEventListener('click', (e) => {
      if (e.target === elements.nlpInfoModal) closeNlpModal();
    });
    
    // Voice Test Button
    elements.voiceTestBtn.addEventListener('click', testCurrentVoice);
    
    // Voice controls
    elements.micBtn.addEventListener('click', () => {
      if (!recognition) {
        showNotification('Puheentunnistus ei ole tuettu tässä selaimessa.', 'error');
        return;
      }
      
      if (micOn) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });
    
    elements.personaSelect.addEventListener('change', (e) => {
      currentPersona = e.target.value;
      const personaName = e.target.options[e.target.selectedIndex].text;
      const voiceConfig = voiceConfigs[currentPersona];
      
      // Show notification with voice info
      let notificationText = `Persona vaihdettu: ${personaName}`;
      if (voiceConfig) {
        notificationText += ` (${voiceConfig.description})`;
      }
      
      showNotification(notificationText, 'info');
      
      // Test the new voice with a sample phrase
      if (voiceOn && availableVoices.length > 0) {
        setTimeout(() => {
          const testPhrase = "Tervetuloa terapiakeskusteluun.";
          speakText(testPhrase);
        }, 500);
      }
    });

    // Enter key to send message
    elements.userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Initialize
    initProgressIndicator();
    initVoices();
    
    // Apply Aurora magnetic card techniques
    aurora.applyTechnique('magnetic-buttons', elements.startSessionCard);
    aurora.applyTechnique('magnetic-buttons', elements.personaCard);
    aurora.applyTechnique('magnetic-buttons', elements.questionCard);
    aurora.applyTechnique('magnetic-buttons', document.querySelector('#nlpInfoBtn').closest('.magnetic-card'));
    aurora.applyTechnique('magnetic-buttons', document.querySelector('#voiceTestBtn').closest('.magnetic-card'));
    
    // Apply morphing cards technique
    aurora.applyTechnique('morphing-cards', elements.startSessionCard);
    aurora.applyTechnique('morphing-cards', elements.personaCard);
    aurora.applyTechnique('morphing-cards', elements.questionCard);
    aurora.applyTechnique('morphing-cards', document.querySelector('#nlpInfoBtn').closest('.magnetic-card'));
    aurora.applyTechnique('morphing-cards', document.querySelector('#voiceTestBtn').closest('.magnetic-card'));
    
    console.log('🌸 TerapiaAI initialized with Aurora UI - Magnetic Cards & Advanced Effects enabled');
  </script>
</body>
</html>